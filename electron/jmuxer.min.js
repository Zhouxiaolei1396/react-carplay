!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("stream")):"function"==typeof define&&define.amd?define(["stream"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).JMuxer=e(t.stream)}(this,(function(t){"use strict";let e,s,i;function r(t,...s){e&&e(t,...s)}function n(t,...e){s&&s(t,...e)}class a{static get NDR(){return 1}static get IDR(){return 5}static get SEI(){return 6}static get SPS(){return 7}static get PPS(){return 8}static get AUD(){return 9}static get TYPES(){return{[a.IDR]:"IDR",[a.SEI]:"SEI",[a.SPS]:"SPS",[a.PPS]:"PPS",[a.NDR]:"NDR",[a.AUD]:"AUD"}}static type(t){return t.ntype in a.TYPES?a.TYPES[t.ntype]:"UNKNOWN"}constructor(t){this.payload=t,this.nri=(96&this.payload[0])>>5,this.ntype=31&this.payload[0],this.isvcl=1==this.ntype||5==this.ntype,this.stype="",this.isfmb=!1}toString(){return`${a.type(this)}: NRI: ${this.getNri()}`}getNri(){return this.nri}type(){return this.ntype}isKeyframe(){return this.ntype===a.IDR}getPayload(){return this.payload}getPayloadSize(){return this.payload.byteLength}getSize(){return 4+this.getPayloadSize()}getData(){const t=new Uint8Array(this.getSize());return new DataView(t.buffer).setUint32(0,this.getSize()-4),t.set(this.getPayload(),4),t}}function o(t,e){let s=new Uint8Array((0|t.byteLength)+(0|e.byteLength));return s.set(t,0),s.set(e,0|t.byteLength),s}function h(t){let e,s,i,r="";return e=Math.floor(t),s=parseInt(e/3600,10)%24,i=parseInt(e/60,10)%60,e=e<0?0:e%60,s>0&&(r+=(s<10?"0"+s:s)+":"),r+=(i<10?"0"+i:i)+":"+(e<10?"0"+e:e),r}class d{constructor(t){this.data=t,this.index=0,this.bitLength=8*t.byteLength}setData(t){this.data=t,this.index=0,this.bitLength=8*t.byteLength}get bitsAvailable(){return this.bitLength-this.index}skipBits(t){if(this.bitsAvailable<t)return!1;this.index+=t}readBits(t,e=!0){return this.getBits(t,this.index,e)}getBits(t,e,s=!0){if(this.bitsAvailable<t)return 0;const i=e%8,r=this.data[e/8|0]&255>>>i,n=8-i;if(n>=t)return s&&(this.index+=t),r>>n-t;{s&&(this.index+=n);const i=t-n;return r<<i|this.getBits(i,e+n,s)}}skipLZ(){let t;for(t=0;t<this.bitLength-this.index;++t)if(0!==this.getBits(1,this.index+t,!1))return this.index+=t,t;return t}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const t=this.skipLZ();return this.readBits(t+1)-1}readEG(){const t=this.readUEG();return 1&t?1+t>>>1:-1*(t>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(t=1){return this.readBits(8*t)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}class l{static extractNALu(t){let e,s,i=0,r=t.byteLength,n=0,a=[],o=0;for(;i<r;)switch(e=t[i++],n){case 0:0===e&&(n=1);break;case 1:n=0===e?2:0;break;case 2:case 3:0===e?n=3:1===e&&i<r?(o!=i-n-1&&a.push(t.subarray(o,i-n-1)),o=i,n=0):n=0}return o<r&&(s=t.subarray(o,r)),[a,s]}static skipScalingList(t,e){let s,i=8,r=8;for(let n=0;n<e;n++)0!==r&&(s=t.readEG(),r=(i+s+256)%256),i=0===r?i:r}static readSPS(t){let e,s,i,r,n,a,o=new d(t),h=0,u=0,c=0,p=0,f=1,y=0;o.readUByte();let m=[],g=t.byteLength;for(let t=1;t<g;t++)t+2<g&&3===o.readBits(24,!1)?(m.push(o.readBits(8)),m.push(o.readBits(8)),t+=2,o.readBits(8)):m.push(o.readBits(8));if(o.setData(new Uint8Array(m)),e=o.readUByte(),o.readBits(5),o.skipBits(3),o.readUByte(),o.skipUEG(),100===e||110===e||122===e||244===e||44===e||83===e||86===e||118===e||128===e){var b=o.readUEG();if(3===b&&o.skipBits(1),o.skipUEG(),o.skipUEG(),o.skipBits(1),o.readBoolean()){a=3!==b?8:12;for(let t=0;t<a;++t)o.readBoolean()&&(t<6?l.skipScalingList(o,16):l.skipScalingList(o,64))}}o.skipUEG();var k=o.readUEG();if(0===k)o.readUEG();else if(1===k){o.skipBits(1),o.skipEG(),o.skipEG(),s=o.readUEG();for(let t=0;t<s;++t)o.skipEG()}if(o.skipUEG(),o.skipBits(1),i=o.readUEG(),r=o.readUEG(),n=o.readBits(1),0===n&&o.skipBits(1),o.skipBits(1),o.readBoolean()&&(h=o.readUEG(),u=o.readUEG(),c=o.readUEG(),p=o.readUEG()),o.readBoolean()){if(o.readBoolean()){let t;switch(o.readUByte()){case 1:t=[1,1];break;case 2:t=[12,11];break;case 3:t=[10,11];break;case 4:t=[16,11];break;case 5:t=[40,33];break;case 6:t=[24,11];break;case 7:t=[20,11];break;case 8:t=[32,11];break;case 9:t=[80,33];break;case 10:t=[18,11];break;case 11:t=[15,11];break;case 12:t=[64,33];break;case 13:t=[160,99];break;case 14:t=[4,3];break;case 15:t=[3,2];break;case 16:t=[2,1];break;case 255:t=[o.readUByte()<<8|o.readUByte(),o.readUByte()<<8|o.readUByte()]}t&&t[0]>0&&t[1]>0&&(f=t[0]/t[1])}if(o.readBoolean()&&o.skipBits(1),o.readBoolean()&&(o.skipBits(4),o.readBoolean()&&o.skipBits(24)),o.readBoolean()&&(o.skipUEG(),o.skipUEG()),o.readBoolean()){let t=o.readUInt(),e=o.readUInt()/(2*t);o.readBoolean()&&(y=e)}}return{fps:y>0?y:void 0,width:Math.ceil((16*(i+1)-2*h-2*u)*f),height:(2-n)*(r+1)*16-(n?2:4)*(c+p)}}static parseHeader(t){let e=new d(t.getPayload());e.readUByte(),t.isfmb=0===e.readUEG(),t.stype=e.readUEG()}constructor(t){this.remuxer=t,this.track=t.mp4track}parseSPS(t){var e=l.readSPS(new Uint8Array(t));this.track.fps=e.fps,this.track.width=e.width,this.track.height=e.height,this.track.sps=[new Uint8Array(t)],this.track.codec="avc1.";let s=new DataView(t.buffer,t.byteOffset+1,4);for(let t=0;t<3;++t){var i=s.getUint8(t).toString(16);i.length<2&&(i="0"+i),this.track.codec+=i}}parsePPS(t){this.track.pps=[new Uint8Array(t)]}parseNAL(t){if(!t)return!1;let e=!1;switch(t.type()){case a.IDR:case a.NDR:e=!0;break;case a.PPS:this.track.pps||(this.parsePPS(t.getPayload()),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),e=!0;break;case a.SPS:this.track.sps||(this.parseSPS(t.getPayload()),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0)),e=!0;break;case a.AUD:r("AUD - ignoing");break;case a.SEI:r("SEI - ignoing")}return e}}class u{static get samplingRateMap(){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350]}static get getAACHeaderData(){return i}static getHeaderLength(t){return 1&t[1]?7:9}static getFrameLength(t){return(3&t[3])<<11|t[4]<<3|(224&t[5])>>>5}static isAACPattern(t){return 255===t[0]&&240==(240&t[1])&&0==(6&t[1])}static extractAAC(t){let e,s,r=0,a=t.byteLength,o=[];if(!u.isAACPattern(t))return n("Invalid ADTS audio format"),o;for(e=u.getHeaderLength(t),i||(i=t.subarray(0,e));r<a;)s=u.getFrameLength(t),o.push(t.subarray(e,s)),t=t.slice(s),r+=s;return o}constructor(t){this.remuxer=t,this.track=t.mp4track}setAACConfig(){let t,e,s,i=new Uint8Array(2),r=u.getAACHeaderData;r&&(t=1+((192&r[2])>>>6),e=(60&r[2])>>>2,s=(1&r[2])<<2,s|=(192&r[3])>>>6,i[0]=t<<3,i[0]|=(14&e)>>1,i[1]|=(1&e)<<7,i[1]|=s<<3,this.track.codec="mp4a.40."+t,this.track.channelCount=s,this.track.config=i,this.remuxer.readyToDecode=!0)}}class c{constructor(t){this.listener={},this.type=""|t}on(t,e){return this.listener[t]||(this.listener[t]=[]),this.listener[t].push(e),!0}off(t,e){if(this.listener[t]){var s=this.listener[t].indexOf(e);return s>-1&&this.listener[t].splice(s,1),!0}return!1}offAll(){this.listener={}}dispatch(t,e){return!!this.listener[t]&&(this.listener[t].map((t=>{t.apply(null,[e])})),!0)}}class p{static init(){var t;for(t in p.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},p.types)p.types.hasOwnProperty(t)&&(p.types[t]=[t.charCodeAt(0),t.charCodeAt(1),t.charCodeAt(2),t.charCodeAt(3)]);var e=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),s=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);p.HDLR_TYPES={video:e,audio:s};var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);p.STTS=p.STSC=p.STCO=r,p.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),p.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),p.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),p.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);var n=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),o=new Uint8Array([0,0,0,1]);p.FTYP=p.box(p.types.ftyp,n,o,n,a),p.DINF=p.box(p.types.dinf,p.box(p.types.dref,i))}static box(t,...e){for(var s,i=8,r=e.length,n=r;r--;)i+=e[r].byteLength;for((s=new Uint8Array(i))[0]=i>>24&255,s[1]=i>>16&255,s[2]=i>>8&255,s[3]=255&i,s.set(t,4),r=0,i=8;r<n;++r)s.set(e[r],i),i+=e[r].byteLength;return s}static hdlr(t){return p.box(p.types.hdlr,p.HDLR_TYPES[t])}static mdat(t){return p.box(p.types.mdat,t)}static mdhd(t,e){return p.box(p.types.mdhd,new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,e>>24,e>>16&255,e>>8&255,255&e,85,196,0,0]))}static mdia(t){return p.box(p.types.mdia,p.mdhd(t.timescale,t.duration),p.hdlr(t.type),p.minf(t))}static mfhd(t){return p.box(p.types.mfhd,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t]))}static minf(t){return"audio"===t.type?p.box(p.types.minf,p.box(p.types.smhd,p.SMHD),p.DINF,p.stbl(t)):p.box(p.types.minf,p.box(p.types.vmhd,p.VMHD),p.DINF,p.stbl(t))}static moof(t,e,s){return p.box(p.types.moof,p.mfhd(t),p.traf(s,e))}static moov(t,e,s){for(var i=t.length,r=[];i--;)r[i]=p.trak(t[i]);return p.box.apply(null,[p.types.moov,p.mvhd(s,e)].concat(r).concat(p.mvex(t)))}static mvex(t){for(var e=t.length,s=[];e--;)s[e]=p.trex(t[e]);return p.box.apply(null,[p.types.mvex].concat(s))}static mvhd(t,e){var s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,2,t>>24&255,t>>16&255,t>>8&255,255&t,e>>24&255,e>>16&255,e>>8&255,255&e,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return p.box(p.types.mvhd,s)}static sdtp(t){var e,s,i=t.samples||[],r=new Uint8Array(4+i.length);for(s=0;s<i.length;s++)e=i[s].flags,r[s+4]=e.dependsOn<<4|e.isDependedOn<<2|e.hasRedundancy;return p.box(p.types.sdtp,r)}static stbl(t){return p.box(p.types.stbl,p.stsd(t),p.box(p.types.stts,p.STTS),p.box(p.types.stsc,p.STSC),p.box(p.types.stsz,p.STSZ),p.box(p.types.stco,p.STCO))}static avc1(t){var e,s,i,r=[],n=[];for(e=0;e<t.sps.length;e++)i=(s=t.sps[e]).byteLength,r.push(i>>>8&255),r.push(255&i),r=r.concat(Array.prototype.slice.call(s));for(e=0;e<t.pps.length;e++)i=(s=t.pps[e]).byteLength,n.push(i>>>8&255),n.push(255&i),n=n.concat(Array.prototype.slice.call(s));var a=p.box(p.types.avcC,new Uint8Array([1,r[3],r[4],r[5],255,224|t.sps.length].concat(r).concat([t.pps.length]).concat(n))),o=t.width,h=t.height;return p.box(p.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,o>>8&255,255&o,h>>8&255,255&h,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,98,105,110,101,108,112,114,111,46,114,117,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,p.box(p.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])))}static esds(t){var e=t.config.byteLength;let s=new Uint8Array(26+e+3);return s.set([0,0,0,0,3,23+e,0,1,0,4,15+e,64,21,0,0,0,0,0,0,0,0,0,0,0,5,e]),s.set(t.config,26),s.set([6,1,2],26+e),s}static mp4a(t){var e=t.audiosamplerate;return p.box(p.types.mp4a,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,e>>8&255,255&e,0,0]),p.box(p.types.esds,p.esds(t)))}static stsd(t){return"audio"===t.type?p.box(p.types.stsd,p.STSD,p.mp4a(t)):p.box(p.types.stsd,p.STSD,p.avc1(t))}static tkhd(t){var e=t.id,s=t.duration,i=t.width,r=t.height,n=t.volume;return p.box(p.types.tkhd,new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,e>>24&255,e>>16&255,e>>8&255,255&e,0,0,0,0,s>>24,s>>16&255,s>>8&255,255&s,0,0,0,0,0,0,0,0,0,0,0,0,n>>0&255,n%1*10>>0&255,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,i>>8&255,255&i,0,0,r>>8&255,255&r,0,0]))}static traf(t,e){var s=p.sdtp(t),i=t.id;return p.box(p.types.traf,p.box(p.types.tfhd,new Uint8Array([0,0,0,0,i>>24,i>>16&255,i>>8&255,255&i])),p.box(p.types.tfdt,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e])),p.trun(t,s.length+16+16+8+16+8+8),s)}static trak(t){return t.duration=t.duration||4294967295,p.box(p.types.trak,p.tkhd(t),p.mdia(t))}static trex(t){var e=t.id;return p.box(p.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(t,e){var s,i,r,n,a,o,h=t.samples||[],d=h.length,l=12+16*d,u=new Uint8Array(l);for(e+=8+l,u.set([0,0,15,1,d>>>24&255,d>>>16&255,d>>>8&255,255&d,e>>>24&255,e>>>16&255,e>>>8&255,255&e],0),s=0;s<d;s++)r=(i=h[s]).duration,n=i.size,a=i.flags,o=i.cts,u.set([r>>>24&255,r>>>16&255,r>>>8&255,255&r,n>>>24&255,n>>>16&255,n>>>8&255,255&n,a.isLeading<<2|a.dependsOn,a.isDependedOn<<6|a.hasRedundancy<<4|a.paddingValue<<1|a.isNonSync,61440&a.degradPrio,15&a.degradPrio,o>>>24&255,o>>>16&255,o>>>8&255,255&o],12+16*s);return p.box(p.types.trun,u)}static initSegment(t,e,s){p.types||p.init();var i,r=p.moov(t,e,s);return(i=new Uint8Array(p.FTYP.byteLength+r.byteLength)).set(p.FTYP),i.set(r,p.FTYP.byteLength),i}}let f=1;class y{static getTrackID(){return f++}flush(){this.mp4track.len=0,this.mp4track.samples=[]}isReady(){return!(!this.readyToDecode||!this.samples.length)||null}}class m extends y{constructor(t){super(),this.readyToDecode=!1,this.nextDts=0,this.dts=0,this.mp4track={id:y.getTrackID(),type:"audio",channelCount:0,len:0,fragmented:!0,timescale:t,duration:t,samples:[],config:"",codec:""},this.samples=[],this.aac=new u(this)}resetTrack(){this.readyToDecode=!1,this.mp4track.codec="",this.mp4track.channelCount="",this.mp4track.config="",this.mp4track.timescale=this.timescale,this.nextDts=0,this.dts=0}remux(t){if(t.length>0)for(let e=0;e<t.length;e++){let s=t[e],i=s.units,r=i.byteLength;this.samples.push({units:i,size:r,duration:s.duration}),this.mp4track.len+=r,this.readyToDecode||this.aac.setAACConfig()}}getPayload(){if(!this.isReady())return null;let t,e,s=new Uint8Array(this.mp4track.len),i=0,n=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){let a=this.samples.shift();a.units,e=a.duration,e<=0?(r(`remuxer: invalid sample duration at DTS: ${this.nextDts} :${e}`),this.mp4track.len-=a.size):(this.nextDts+=e,t={size:a.size,duration:e,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}},s.set(a.units,i),i+=a.size,n.push(t))}return n.length?new Uint8Array(s.buffer,0,this.mp4track.len):null}}class g extends y{constructor(t){super(),this.readyToDecode=!1,this.nextDts=0,this.dts=0,this.mp4track={id:y.getTrackID(),type:"video",len:0,fragmented:!0,sps:"",pps:"",fps:30,width:0,height:0,timescale:t,duration:t,samples:[]},this.samples=[],this.h264=new l(this)}resetTrack(){this.readyToDecode=!1,this.mp4track.sps="",this.mp4track.pps="",this.nextDts=0,this.dts=0}remux(t){for(let e of t){let t=[],s=0;for(let i of e.units)this.h264.parseNAL(i)&&(t.push(i),s+=i.getSize());t.length>0&&this.readyToDecode&&(this.mp4track.len+=s,this.samples.push({units:t,size:s,keyFrame:e.keyFrame,duration:e.duration}))}}getPayload(){if(!this.isReady())return null;let t,e,s=new Uint8Array(this.mp4track.len),i=0,n=this.mp4track.samples;for(this.dts=this.nextDts;this.samples.length;){let a=this.samples.shift(),o=a.units;if(e=a.duration,e<=0)r(`remuxer: invalid sample duration at DTS: ${this.nextDts} :${e}`),this.mp4track.len-=a.size;else{this.nextDts+=e,t={size:a.size,duration:e,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,isNonSync:a.keyFrame?0:1,dependsOn:a.keyFrame?2:1}};for(const t of o)s.set(t.getData(),i),i+=t.getSize();n.push(t)}}return n.length?new Uint8Array(s.buffer,0,this.mp4track.len):null}}class b extends c{constructor(t){super("remuxer"),this.initialized=!1,this.trackTypes=[],this.tracks={},this.seq=1,this.env=t,this.timescale=1e3,this.mediaDuration=0}addTrack(t){"video"!==t&&"both"!==t||(this.tracks.video=new g(this.timescale),this.trackTypes.push("video")),"audio"!==t&&"both"!==t||(this.tracks.audio=new m(this.timescale),this.trackTypes.push("audio"))}reset(){for(let t of this.trackTypes)this.tracks[t].resetTrack();this.initialized=!1}destroy(){this.tracks={},this.offAll()}flush(){if(this.initialized)for(let t of this.trackTypes){let e=this.tracks[t],s=e.getPayload();if(s&&s.byteLength){let i={type:t,payload:o(p.moof(this.seq,e.dts,e.mp4track),p.mdat(s)),dts:e.dts};"video"===t&&(i.fps=e.mp4track.fps),this.dispatch("buffer",i);let n=h(e.dts/this.timescale);r(`put segment (${t}): dts: ${e.dts} frames: ${e.mp4track.samples.length} second: ${n}`),e.flush(),this.seq++}}else this.isReady()&&(this.dispatch("ready"),this.initSegment(),this.initialized=!0,this.flush())}initSegment(){let t=[];for(let e of this.trackTypes){let s=this.tracks[e];if("browser"==this.env){let t={type:e,payload:p.initSegment([s.mp4track],this.mediaDuration,this.timescale)};this.dispatch("buffer",t)}else t.push(s.mp4track)}if("node"==this.env){let e={type:"all",payload:p.initSegment(t,this.mediaDuration,this.timescale)};this.dispatch("buffer",e)}r("Initial segment generated.")}isReady(){for(let t of this.trackTypes)if(!this.tracks[t].readyToDecode||!this.tracks[t].samples.length)return!1;return!0}remux(t){for(let e of this.trackTypes){let s=t[e];"audio"===e&&this.tracks.video&&!this.tracks.video.readyToDecode||s.length>0&&this.tracks[e].remux(s)}this.flush()}}class k extends c{constructor(t,e){super("buffer"),this.type=e,this.queue=new Uint8Array,this.cleaning=!1,this.pendingCleaning=0,this.cleanOffset=30,this.cleanRanges=[],this.sourceBuffer=t,this.sourceBuffer.addEventListener("updateend",(()=>{this.pendingCleaning>0&&(this.initCleanup(this.pendingCleaning),this.pendingCleaning=0),this.cleaning=!1,this.cleanRanges.length&&this.doCleanup()})),this.sourceBuffer.addEventListener("error",(()=>{this.dispatch("error",{type:this.type,name:"buffer",error:"buffer error"})}))}destroy(){this.queue=null,this.sourceBuffer=null,this.offAll()}doCleanup(){if(!this.cleanRanges.length)return void(this.cleaning=!1);let t=this.cleanRanges.shift();r(`${this.type} remove range [${t[0]} - ${t[1]})`),this.cleaning=!0,this.sourceBuffer.remove(t[0],t[1])}initCleanup(t){try{if(this.sourceBuffer.updating)return void(this.pendingCleaning=t);if(this.sourceBuffer.buffered&&this.sourceBuffer.buffered.length&&!this.cleaning){for(let e=0;e<this.sourceBuffer.buffered.length;++e){let s=this.sourceBuffer.buffered.start(e),i=this.sourceBuffer.buffered.end(e);t-s>this.cleanOffset&&(i=t-this.cleanOffset,s<i&&this.cleanRanges.push([s,i]))}this.doCleanup()}}catch(t){n(`Error occured while cleaning ${this.type} buffer - ${t.name}: ${t.message}`)}}doAppend(){if(this.queue.length&&this.sourceBuffer&&!this.sourceBuffer.updating)try{this.sourceBuffer.appendBuffer(this.queue),this.queue=new Uint8Array}catch(t){let e="unexpectedError";"QuotaExceededError"===t.name?(r(`${this.type} buffer quota full`),e="QuotaExceeded"):(n(`Error occured while appending ${this.type} buffer - ${t.name}: ${t.message}`),e="InvalidStateError"),this.dispatch("error",{type:this.type,name:e,error:"buffer error"})}}feed(t){this.queue=o(this.queue,t)}}class x extends c{static isSupported(t){return window.MediaSource&&window.MediaSource.isTypeSupported(t)}constructor(t){console.log("creating jmuxer instance"),super("jmuxer"),this.isReset=!1;this.options=Object.assign({},{node:"",mode:"both",flushingTime:500,maxDelay:500,clearBuffer:!0,fps:30,readFpsFromTrack:!1,debug:!1,onReady:function(){},onError:function(){}},t),this.env="object"==typeof process&&"undefined"==typeof window?"node":"browser",this.options.debug&&(e=console.log,s=console.error),this.options.fps||(this.options.fps=30),this.frameDuration=1e3/this.options.fps|0,this.remuxController=new b(this.env),this.remuxController.addTrack(this.options.mode),this.initData(),this.remuxController.on("buffer",this.onBuffer.bind(this)),"browser"==this.env&&(this.remuxController.on("ready",this.createBuffer.bind(this)),this.initBrowser())}initData(){this.lastCleaningTime=Date.now(),this.kfPosition=[],this.kfCounter=0,this.pendingUnits={},this.remainingData=new Uint8Array,this.startInterval()}initBrowser(){"string"==typeof this.options.node&&""==this.options.node&&n("no video element were found to render, provide a valid video element"),this.node="string"==typeof this.options.node?document.getElementById(this.options.node):this.options.node,this.mseReady=!1,this.setupMSE()}createStream(){let e=this.feed.bind(this),s=this.destroy.bind(this);return this.stream=new t.Duplex({writableObjectMode:!0,read(t){},write(t,s,i){e(t),i()},final(t){s(),t()}}),this.stream}setupMSE(){if(window.MediaSource=window.MediaSource||window.WebKitMediaSource,!window.MediaSource)throw"Oops! Browser does not support media source extension.";this.isMSESupported=!!window.MediaSource,this.mediaSource=new MediaSource,this.url=URL.createObjectURL(this.mediaSource),this.node.src=this.url,this.mseEnded=!1,this.mediaSource.addEventListener("sourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("sourceclose",this.onMSEClose.bind(this)),this.mediaSource.addEventListener("webkitsourceopen",this.onMSEOpen.bind(this)),this.mediaSource.addEventListener("webkitsourceclose",this.onMSEClose.bind(this))}endMSE(){if(!this.mseEnded)try{this.mseEnded=!0,this.mediaSource.endOfStream()}catch(t){n("mediasource is not available to end")}}feed(t){let e,s,i,r=!1,a={video:[],audio:[]};if(t&&this.remuxController){if(i=t.duration?parseInt(t.duration):0,t.video){if(t.video=o(this.remainingData,t.video),[e,s]=l.extractNALu(t.video),this.remainingData=s||new Uint8Array,!(e.length>0))return void n("Failed to extract any NAL units from video data:",s);a.video=this.getVideoFrames(e,i),r=!0}if(t.audio){if(e=u.extractAAC(t.audio),!(e.length>0))return void n("Failed to extract audio data from:",t.audio);a.audio=this.getAudioFrames(e,i),r=!0}r?this.remuxController.remux(a):n("Input object must have video and/or audio property. Make sure it is a valid typed array")}}getVideoFrames(t,e){let s=[],i=[],n=0,o=0,h=!1,d=!1;this.pendingUnits.units&&(s=this.pendingUnits.units,d=this.pendingUnits.vcl,h=this.pendingUnits.keyFrame,this.pendingUnits={});for(let e of t){let t=new a(e);t.type()!==a.IDR&&t.type()!==a.NDR||l.parseHeader(t),s.length&&d&&(t.isfmb||!t.isvcl)&&(i.push({units:s,keyFrame:h}),s=[],h=!1,d=!1),s.push(t),h=h||t.isKeyframe(),d=d||t.isvcl}if(s.length)if(e)if(d)i.push({units:s,keyFrame:h});else{let t=i.length-1;t>=0&&(i[t].units=i[t].units.concat(s))}else this.pendingUnits={units:s,keyFrame:h,vcl:d};return n=e?e/i.length|0:this.frameDuration,o=e?e-n*i.length:0,i.map((t=>{t.duration=n,o>0&&(t.duration++,o--),this.kfCounter++,t.keyFrame&&this.options.clearBuffer&&this.kfPosition.push(this.kfCounter*n/1e3)})),r(`jmuxer: No. of frames of the last chunk: ${i.length}`),i}getAudioFrames(t,e){let s=[],i=0,r=0;for(let e of t)s.push({units:e});return i=e?e/s.length|0:this.frameDuration,r=e?e-i*s.length:0,s.map((t=>{t.duration=i,r>0&&(t.duration++,r--)})),s}destroy(){if(this.stopInterval(),this.stream&&(this.remuxController.flush(),this.stream.push(null),this.stream=null),this.remuxController&&(this.remuxController.destroy(),this.remuxController=null),this.bufferControllers){for(let t in this.bufferControllers)this.bufferControllers[t].destroy();this.bufferControllers=null,this.endMSE()}this.node=!1,this.mseReady=!1,this.videoStarted=!1,this.mediaSource=null}reset(){if(this.stopInterval(),this.isReset=!0,this.node.pause(),this.remuxController&&this.remuxController.reset(),this.bufferControllers){for(let t in this.bufferControllers)this.bufferControllers[t].destroy();this.bufferControllers=null,this.endMSE()}this.initData(),"browser"==this.env&&this.initBrowser(),r("JMuxer was reset")}createBuffer(){if(this.mseReady&&this.remuxController&&this.remuxController.isReady()&&!this.bufferControllers){this.bufferControllers={};for(let t in this.remuxController.tracks){let e=this.remuxController.tracks[t];if(!x.isSupported(`${t}/mp4; codecs="${e.mp4track.codec}"`))return n("Browser does not support codec"),!1;let s=this.mediaSource.addSourceBuffer(`${t}/mp4; codecs="${e.mp4track.codec}"`);this.bufferControllers[t]=new k(s,t),this.bufferControllers[t].on("error",this.onBufferError.bind(this))}}}startInterval(){this.interval=setInterval((()=>{this.options.flushingTime?this.applyAndClearBuffer():this.bufferControllers&&this.cancelDelay()}),this.options.flushingTime||1e3)}stopInterval(){this.interval&&clearInterval(this.interval)}cancelDelay(){if(this.node.buffered&&this.node.buffered.length>0&&!this.node.seeking){const t=this.node.buffered.end(0);t-this.node.currentTime>this.options.maxDelay/1e3&&(console.log("delay"),this.node.currentTime=t-.001)}}releaseBuffer(){for(let t in this.bufferControllers)this.bufferControllers[t].doAppend()}applyAndClearBuffer(){this.bufferControllers&&(this.releaseBuffer(),this.clearBuffer())}getSafeClearOffsetOfBuffer(t){let e,s="audio"===this.options.mode&&t||0;for(let s=0;s<this.kfPosition.length&&!(this.kfPosition[s]>=t);s++)e=this.kfPosition[s];return e&&(this.kfPosition=this.kfPosition.filter((t=>(t<e&&(s=t),t>=e)))),s}clearBuffer(){if(this.options.clearBuffer&&Date.now()-this.lastCleaningTime>1e4){for(let t in this.bufferControllers){let e=this.getSafeClearOffsetOfBuffer(this.node.currentTime);this.bufferControllers[t].initCleanup(e)}this.lastCleaningTime=Date.now()}}onBuffer(t){this.options.readFpsFromTrack&&void 0!==t.fps&&this.options.fps!=t.fps&&(this.options.fps=t.fps,this.frameDuration=Math.ceil(1e3/t.fps),r(`JMuxer changed FPS to ${t.fps} from track data`)),"browser"==this.env?this.bufferControllers&&this.bufferControllers[t.type]&&this.bufferControllers[t.type].feed(t.payload):this.stream&&this.stream.push(t.payload),0===this.options.flushingTime&&this.applyAndClearBuffer()}onMSEOpen(){this.mseReady=!0,URL.revokeObjectURL(this.url),"function"==typeof this.options.onReady&&this.options.onReady.call(null,this.isReset)}onMSEClose(){this.mseReady=!1,this.videoStarted=!1}onBufferError(t){if("QuotaExceeded"==t.name)return r(`JMuxer cleaning ${t.type} buffer due to QuotaExceeded error`),void this.bufferControllers[t.type].initCleanup(this.node.currentTime);"InvalidStateError"==t.name?(r("JMuxer is reseting due to InvalidStateError"),this.reset()):this.endMSE(),"function"==typeof this.options.onError&&this.options.onError.call(null,t)}}return x}));
